# OSPF 路由协议

## OSPF 简介

LSDB 和 SPF

## OSPF 基本原理

Hello协议交互 - 形成邻居关系
设备运行OSPF协议后，会从所有启动OSPF协议的接口上发出Hello数据包。如果两台设备共享一条公共数据链路，并且能够互相成功协商他们各自Hello数据包中所指定的某些参数，那么他们就成了邻居关系。

LSAs的泛洪-通告链路状态信息
形成邻接关系的设备之间就可以交互LSA了，如图2所示。通过第一篇我们知道，LSA全称是链路状态通告，它描述了设备所有的链路、接口、邻居及链路状态等信息。设备间正是不断的泛洪交互这些链路信息，来了解整个网络的拓扑信息。由于链路的多样性，OSPF协议定义了许多LSA类型，后面的篇章会详细介绍到。

LSDB的组建-形成带权有向图
通过泛洪LSA，设备接下来会把收到的LSA汇总记录在LSDB（链路状态数据库）当中，最终，所有设备都会形成同样的LSDB，如图3所示。LSA是对设备周围网络拓扑结构的描述，而LSDB则是对整个自治系统的网络拓扑结构的描述，LSDB是LSA的汇总。

SPF的计算-形成路由
当LSDB同步完之后，每一台设备都将以其自身为根，使用SPF算法来计算一个无环路的拓扑图，以描述它所知道的到达每一个目的地的最短路径（最小的路径代价），如图4所示。这个拓扑图就是SPF算法树，有了这棵“树”，事实上路由器就已经知道了到达网络各个角落的最优路径。

路由表的维护更新
最终，经过SPF算法得出了最短路径树，每台设备将SPF算法得出的最短路径装载进路由表形成指导数据转发的路由表项，并且实时更新，如图5所示。同时，邻居之间交互Hello报文进行Keepalive，维持邻居/邻接关系，并且每30min重传一次LSA。如果网络拓扑稳定，那么网络中将不会有什么活动或行为发生。

## Router ID

Router ID就是用于在自治系统中唯一标识一台运行OSPF的路由器的32位整数。每个运行OSPF的路由器都有一个Router ID。Router ID的格式和IP地址的格式是一样的，在实际网络部署中，考虑到协议的稳定，推荐使用路由器Loopback0的IP地址做为路由器的Router ID。

Router ID的选取有两种方式：

通过命令行手动配置。
设备自动设定。

如果没有手动配置Router ID，设备会从当前接口的IP地址中自动选取一个作为Router ID。其选择顺序是：
1、优先从Loopback地址中选择最大的IP地址作为Router ID。

2、如果没有配置Loopback接口，则在接口地址中选取最大的IP地址作为Router ID。

只有重新配置系统的Router ID或OSPF的Router ID，并且重新启动OSPF进程后，才会进行Router ID的重新选取。

## 网络类型

  广播（Broadcast）类型

当链路层协议是Ethernet、FDDI时，OSPF缺省认为网络类型是Broadcast。在该类型的网络中，通常以组播形式（224.0.0.5：含义是OSPF路由器的预留IP组播地址；224.0.0.6：含义是OSPF DR的预留IP组播地址）发送Hello报文、LSU报文和LSAck报文；以单播形式发送DD报文和LSR报文。

  NBMA（Non-Broadcast Multi-Access）类型

当链路层协议是帧中继、ATM或X.25时，OSPF缺省认为网络类型是NBMA。在该类型的网络中，以单播形式发送协议报文（Hello报文、DD报文、LSR报文、LSU报文、LSAck报文）。

 点到多点P2MP（point-to-multipoint）类型。

没有一种链路层协议会被缺省的认为是Point-to-Multipoint类型。点到多点必须是由其他的网络类型强制更改的。常用做法是将非全连通的NBMA改为点到多点的网络。在该类型的网络中，以组播形式（224.0.0.5）发送Hello报文，以单播形式发送其他协议报文（DD报文、LSR报文、LSU报文、LSAck报文）。  

 点到点P2P（point-to-point）类型

当链路层协议是PPP、HDLC和LAPB时，OSPF缺省认为网络类型是P2P。在该类型的网络中，以组播形式（224.0.0.5）发送协议报文（Hello报文、DD报文、LSR报文、LSU报文、LSAck报文）。

## DR

在广播网和NBMA网络中，任意两台路由器之间都要传递路由信息。

这使得任何一台路由器的路由变化都会导致多次传递，浪费了带宽资源。为解决这一问题，OSPF定义了指定路由器DR。通过选举产生DR（Designated 路由器）后，所有其他设备都只将信息发送给DR，由DR将网络链路状态LSA广播出去。为了防止DR发生故障时，重新选举DR时会产成业务中断，除了DR之外，还会选举一个备份指定路由器BDR。这样除DR和BDR之外的路由器（称为DR Other）之间将不再建立邻接关系，也不再交换任何路由信息，这样就减少了广播网和NBMA网络上各路由器之间邻接关系的数量。这就是OSPF给那白袍小将的锦囊妙计。

### DR/BDR 选举原则

在广播网和NBMA网络中，为了稳定地进行DR和BDR的选举，OSPF规定了一系列的选举规则，遵循三个基本原则：选举制、****、世袭制。下面我们来逐个介绍一下。

- 选举制：选举中使用的“选票”就是Hello报文。每台路由器将自己选出的DR写入Hello报文中，发给网段上的其他路由器。当处于同一网段的两台路由器同时宣布自己是DR时，DR优先级高者胜出。如果优先级相等，则路由器 ID大者胜出。如果一台路由器的优先级为0，则它不会被选举为DR或BDR。

- 所谓也叫非抢占制。每一台新加入的路由器并不急于参加选举，而是先考察一下本网段中是否已有DR存在。如果目前网段中已经存在DR，即使本路由器的DR优先级比现有的DR还高，也不会再声称自己是DR了。而是承认现有的DR。因为网段中的每台路由器都只和DR/BDR建立邻接关系，如果DR频繁的更迭，则每次都要重新引起本网段内的所有路由器与新的DR/BDR建立邻接关系。 这样会导致在短时间内网段中有大量的OSPF协议报文在传输，降低网络的可用带宽。****有利于增加网络的稳定性、提高网络的可用带宽。实际上在一个多访问网络上，最先初始化启动的两台具有DR选举资格的路由器将成为DR和BDR路由器。

- 所谓世袭制就是如果DR故障了，那么下一个当选为DR的一定是BDR，其他的路由器只能去竞选BDR的位置。这个原则都是为了保证DR是比较稳定的，不会经常进行选举的，并且DR是有备份的（BDR），一旦DR失效，可以马上由BDR来承担DR的角色，由于DR和BDR的数据库是完全同步的，这样当DR故障后，BDR立即成为DR，履行DR的职责，而且邻接关系已经建立，所以从角色切换到承载业务的时间会很短。同时，在BDR成为新的DR之后，还会选举出一个新的BDR，虽然这个过程所需的时间比较长，但这个已经不会影响路由的计算了。

### DR/BDR 选举步骤

广播链路或者NMBA链路上DR/BDR详细的选举过程如下：

（1）接口UP后，发送Hello报文，同时进入到waiting状态。在waiting状态下会有一个waiting timer，该timer的长度与dead timer是一样的。默认值40s，用户不可自行调整。

（2）在waiting timer触发前，发送的hello报文是没有DR和BDR字段的。在waiting阶段，如果收到Hello报文中有DR和BDR，那么直接承认网络中的DR和BDR，而不会触发选举。直接离开waiting状态，开始邻居同步。

（3）假设网络中已经存在一个DR和一个BDR，这时新加入网络中的设备，不论它的Router ID或者DR优先级有多大，都会承认现网中已有的DR和BDR。

（4）当DR因为故障down掉之后，BDR会继承DR的位置，剩下的优先级大于0的设备会竞争成为新的BDR。

（5）只有当不同Router ID，或者配置不同DR优先级的设备同时起来，在同一时刻进行DR选举才会应用DR选举规则产生DR。该规则是：优先选择DR优先级最高的作为DR，次高的作为BDR。DR优先级为0的设备只能成为DRother；如果优先级相同，则优先选择Router ID较大的设备成为DR，次大的成为BDR，其余设备成为DRother。

假设 4 台路由器通过交换机互联

这表示DR/BDR与邻居间建立的是邻接关系，而DROther之间建立的只是邻居关系。

Full就表示邻接关系，2-Way就表示邻居关系

如果广播网络上不存在具备DR/BDR选举资格的设备，那么这个网络上将没有DR或者BDR路由器，而且也不会建立任何邻接关系。在这种情况下，网络上所有的路由器的邻居状态都将停留在“2-Way”状态。

## OSPF 接口

我们知道OSPF是链路状态协议，运行OSPF的设备间通过交互链路状态信息（即LSA），最后每台OSPF设备都形成一个链路状态数据库（即LSDB），从而知道整张网络的拓扑信息。而这些链路信息最初的源头肯定都是OSPF设备本身相连的本地链路信息，那么这些信息又是从哪里获得的呢？答案是与链路直连的OSPF接口。

1）Router ID：设备的ID，第二篇中介绍到的，保证设备在OSPF网络的唯一性。
2）Area：接口所在的区域ID。关于区域ID，在第四篇中会详细介绍。
3）Interface：接口的基本信息，包括接口的IP地址、接口编号。始发于这个接口的OSPF报文将把这个IP地址作为源地址。
4）Cost：接口开销值，即此接口发送出去的数据包在链路中传输需要花费的开销值。
OSPF在生成SPF时，就依据这些链路开销值，选出最优的数据转发链路。
5）Type：接口类型，即这个接口相连的链路类型，包括P2P、P2MP、广播或NBMA。
6）Priority：设备接口在选取DR和BDR时的优先级。其值越大，优先级越高。
7）DesignatedRouter：接口所在广播网络/NBMA网络上的指定设备，即DR。一般用连接这个广播网络/NBMA网络的接口地址表示。比如192.168.23.0/24这个广播网络/NBMA网络的DR是相连接口地址为192.168.3.2的设备。
8）BackupDesignatedRouter：接口所在网络上的备份指定设备，BDR。一般用连接这个广播网络/NBMA网络的接口地址表示。比如192.168.23.0/24这个广播网络/NBMA网络的BDR是相连接口地址为192.168.3.1的设备。
9）Hello：接口发送Hello报文的时间间隔。
10）Dead：接口相连的OSPF邻居失效时间。超过失效时间，如果接口还没有收到邻居设备发来的Hello报文，就表明两端的邻居关系已无效。华为S系列交换机在默认情况下，邻居失效时间为发送Hello报文时间间隔的4倍。
11）Poll：NBMA网络上发送轮询Hello报文的时间间隔。在NBMA网络上，当邻居失效后，设备将按轮询时间间隔定期地发送Hello报文。轮询时间间隔值至少应为Hello报文时间间隔的4倍，华为S系列交换机在默认情况下发送轮询Hello报文的时间间隔是发送Hello报文时间间隔的4倍。
12）Retransmit：接口没有收到来自对端“LSA已经收到”的确认报文，需要重传LSA的等待时间。
13）Transmit Delay：接口发送LSA过程中的传输延迟时间。

## 接口状态机

OSPF设备从接口获取了链路信息后，然后与相邻设备建立邻接连接，交互这些信息。在建立邻接关系之前，邻居设备间需要明确角色分工，才能正常建立连接。那角色分工通过什么来了解呢？其实在图1的接口信息中，我们还有一个非常关键的字段没有介绍，那就是State字段。通过这个字段，我们就可以了解OSPF设备在一段链路中的作用。而这也就是OSPF接口的七般变化。每个设备通过这七般变化，顺势而为，扮演好自己在这段链路中的角色。

接口总共有下面7种状态：

- Down：接口的初始状态。表明此时接口不可用，不能用于收发流量。
- Loopback：设备到网络的接口处于环回状态。环回接口不能用于正常的数据传输，但仍能通过ICMP ping或位错误检测来收集接口信息。
- Waiting：设备正在判定网络上的DR和BDR。在设备参与DR/BDR选举前，接口上会起一个Waiting定时器。在这个定时器超时前，设备发送的Hello报文不包含DR和BDR信息，设备不能被选举为DR或BDR，因为从第二篇可以知道，正常的DR/BDR选举遵循非抢占原则。这可以避免不必要地改变链路中已存在的DR和BDR。仅NMBA网络、广播网络有此状态。
- P-2-P：接口连接到物理点对点网络或者是虚拟链路，这个时候设备会与链路连接的另一端设备建立邻接关系。仅P2P、P2MP网络有此状态。
- DROther：设备没有被选为DR或BDR，但连接到广播网络或NBMA网络上的其他设备被选举为DR。它会与DR和BDR建立邻接关系。
- BDR：设备是相连网络的BDR，并将在当前的DR失效时成为DR。该设备与接入该网络的所有其他设备建立邻接关系。
- DR：设备是相连网络的DR。该设备与接入该网络的所有其他设备建立邻接关系。

## LSA 交互

### OSPF 邻居

邻居关系：OSPF设备启动后，会通过OSPF接口向外发送Hello报文，收到Hello报文的OSPF设备会检查报文中所定义的参数，比如Hello报文发送间隔、网络类型、IP地址掩码等，如果双方一致就会形成邻居关系，两端设备互为邻居。
邻接关系：位于邻居关系之上，如果两端需要进一步交换DD报文、交互LSA信息，才建立邻接关系。
如果根据邻居状态理解，邻居关系是指邻居状态达到了2-way状态，而邻接关系则需要达到Exstart以上状态。

### OSPF协议报文

Hello报文：最常用的报文，其作用为建立和维护邻接关系，周期性地在使能了OSPF的接口上发送。报文内容包括一些定时器的数值、本网络中的DR、BDR以及已知的邻居。
DD报文：两台设备在邻接关系初始化时，用DD报文描述本端设备的LSDB，进行数据库的同步。报文内容包括LSDB中每一条LSA的Header（LSA的Header可以唯一标识一条LSA），即所有LSA的摘要信息。LSA Header只占一条LSA的整个数据量的一小部分，这样可以减少设备之间的协议报文流量，对端设备根据LSA Header就可以判断出是否已有这条LSA。在两台设备交换DD报文的过程中，一台为Master，另一台为Slave。由Master规定起始序列号，每发送一个DD报文序列号加1，Slave方使用Master的序列号作为确认。
LSR报文：两台设备互相交换过DD报文之后，需要发送LSR报文向对方请求更新LSA，内容包括所需要的LSA的摘要信息。
LSU报文：LSU报文用来向对端设备发送其所需要的LSA或者泛洪本端更新的LSA，内容是多条LSA（全部内容）的集合。为了实现Flooding的可靠性传输，需要LSAck报文对其进行确认，对没有收到确认报文的LSA进行重传，重传的LSA是直接发送到邻居的。
LSAck报文：LSAck报文用来对接收到的LSU报文进行确认，内容是需要确认的LSA的Header（一个LSAck报文可对多个LSA进行确认）。

对于OSPF邻居字段信息的详细解释如下。

1）Area：邻居所属的区域。

2）Interface：与邻居相连的接口。

3）Router ID：邻居的Router ID。

4）Address：邻居接口的IP地址。

5）State：邻居状态。

6）Mode： DD交换进程中协商的主从状态。

- Nbr is Master，邻居是Master，主动发送DD报文。

- Nbr is Slave，邻居是Slave，配合Master发送DD报文。

7）Priority：邻居的DR优先级。

8）DR：邻居间指定路由器的IP地址。

9）BDR：邻居间备份指定路由器的IP地址。

10）Dead timer ： 邻居失效定时器。如果在超时时间内，还没有收到邻居发来的Hello报文，说明邻居已失效。

11）Retrans timer interval：重传LSA的时间间隔。如果在这个间隔内，没有收到邻居的LSA已经收到的确认报文，LSA会进行重传。

，OSPF说的琴瑟和鸣***正是相邻设备间通过不同的邻居状态切换，最后形成完全的邻接关系，完成LSA信息的交互。

邻居状态机总共有8种状态：

Down：邻居会话的初始阶段。表明没有在邻居失效时间间隔内收到来自邻居设备的Hello报文。除了NBMA网络OSPF路由器会每隔PollInterval时间对外轮询发送Hello报文，包括向处于Down状态的邻居路由器（即失效的邻居路由器）发送之外，其他网络是不会向失效的邻居路由器发送Hello报文的。

Attempt：这种状态适用于NBMA网络，邻居路由器是手工配置的。邻居处于本状态时，路由器会每隔HelloInterval时间向自己手工配置的邻居发送Hello报文，尝试建立邻居关系。

Init：本状态表示已经收到了邻居的Hello报文，但是对端并没有收到本端发送的Hello报文，收到的Hello报文的邻居列表并没有包含本端的Router ID，双向通信仍然没有建立。

2-way：互为邻居。本状态表示双方互相收到了对端发送的Hello报文，报文中的邻居列表也包含本端的Router ID，邻居关系建立。如果不形成邻接关系则邻居状态机就停留在此状态，否则进入Exstart状态。而且DR/BDR只有在邻居状态处于这个状态或者更高的状态才会被选举出来。

Exstart：协商主/从关系。建立主/从关系主要是为了保证在后续的DD报文交换中能够有序的发送。邻居间从此时才开始正式建立邻接关系。

Exchange：交换DD报文。本端设备将本地的LSDB用DD报文来描述，并发给邻居设备。

Loading：正在同步LSDB。两端设备发送LSR报文向邻居请求对方的LSA，同步LSDB。

Full：建立邻接。两端设备的LSDB已同步，本端设备和邻居设备建立了完全的邻接关系。

## OSPF 区域

### 划分

OSPF将自治系统划分成不同的区域。区域是从逻辑上将路由器划分为不同的组，每个组用区域号（Area ID）来标识。区域的边界是路由器，而不是链路。一个网段（链路）只能属于一个区域，或者说每个运行OSPF的接口必须指明属于哪一个区域。

骨干区域

OSPF划分区域之后，并非所有的区域都是平等的关系。其中有一个区域其区域号（Area ID）是0，通常被称为骨干区域。骨干区域是连接所有其他OSPF区域的中央区域，骨干区域负责区域之间的路由，非骨干区域之间的路由信息必须通过骨干区域来转发。对此，OSPF有两个规定：
所有非骨干区域必须与骨干区域保持连通；
骨干区域自身也必须保持连通。

标准区域

标准区域是最通用的区域，它传输区域内路由，区域间路由和外部路由。

特殊区域

OSPF为了进一步精细化管理LSA的传播，还划分了4个特殊区域：

Stub区域：Stub区域不允许自治系统外部的路由（Type5 LSA）在区域内传播。
Totally Stub区域：Totally Stub区域既不允许自治系统外部的路由（Type5 LSA）在区域内传播，也不允许区域间路由（Type3 LSA）在区域内传播。
NSSA区域：NSSA区域允许引入少量通过本区域的ASBR到达的外部路由，但不允许其他区域的外部路由AS-external-LSA（Type5 LSA）在区域内传播。
Totally NSSA区域：Totally NSSA区域既不允许其他区域的外部路由ASE LSA（Type5 LSA）在区域内传播，也不允许区域间路由Network-summary-LSA（Type3 LSA）在区域内传播。

关于OSPF特殊区域我们在后面的章节会有详细的介绍。

OSPF通过区域划分的方式将一个大型的网络分解成多个小区域进行管理，这实际上也是一种网络的分层拓扑结构，这种方式解决了OSPF网络的几个难题，详细如下：

1、解决LSDB日益庞大的问题。

划分区域以后，由于LSDB只需要在一个区域内进行维护，因此，大量的LSA泛洪扩散就被限制在一个区域里面了。此时路由器仅仅需要和它所在区域的其他路由器具有相同的LSDB，而没有必要和整个OSPF域内的所有路由器共享相同的LSDB。也就是说，划分区域以后，在一个区域内的路由器将不需要了解他所在区域外部的拓扑细节。因此，在这种情况下LSDB的规模就会大大缩减，降低了对路由器内存和CPU的消耗。同时划分区域以后，可以充分利用路由策略、路由汇总、特殊区域等等各种手段进一步优化网络结构，进一步减少LSA的规模。

2、提高了信息传递效率

划分区域以后，区域之间只交换汇总的路由信息，而不是交换每条详细的路由，这样LSA泛洪的数量就会大大减小，用户维护路由表的协议报文数量就会减少，从而空余出更多的链路带宽供业务报文使用，这对提高信息传递的效率是有好处的。

3、提高了网络稳定性

OSPF网络划分其余以后，一个区域内参与SPF算法的只有区域内的LSA，其他的区域的LSA不参与本区域的SPF算法。例如如图3中，区域1有一条链路质量不好一直处于闪断中，所以区域1的SPF算法会频繁的运算，但是这种影响仅局限在区域1内，其他区域不会因此而重新执行SPF算法，所以这种情况下，网络的震荡被限制在一个更小的范围内，提高了网络的稳定性。

### 区域环路

为了避免区域间的环路，OSPF规定直接在两个非骨干区域之间发布路由信息是不允许的，只允许在一个区域内部或者在骨干区域和非骨干区域之间发布路由信息。因此，每个区域边界路由器（ABR）都必须连接到骨干区域。

### 路由器角色

路由器角色

含义

区域内路由器（Internal Router）该类路由器的所有接口都属于同一个OSPF区域。

区域边界路由器ABR（Area Border Router）该类路由器可以同时属于两个以上的区域，但其中一个必须是骨干区域。ABR用来连接骨干区域和非骨干区域，它与骨干区域之间既可以是物理连接，也可以是逻辑上的连接。

骨干路由器（Backbone Router）该类路由器至少有一个接口属于骨干区域。所有的ABR和位于骨干区域Area0内部的路由器都是骨干路由器。

自治系统边界路由器ASBR（AS Boundary Router）与其他AS交换路由信息的路由器称为ASBR。ASBR并不一定位于AS的边界，它可能是区域内路由器，也可能是ABR。

### 虚连接

如果骨干和非骨干不能物理上连接，则可以配置虚连接，其中转发路由器将虚连接报文当作正常ip报文转发。

## OSPF LSA

LSA报文主要分LSA头部和LSA信息字段。所有类型的LSA报文，其LSA头部包含的字段都是一样的，唯一不同的是Link state ID字段含义。在LSA头部中，我们主要关心以下三个字段：

- Link-State Advertisement Type：LSA类型
- Link state ID：链路状态ID。在Router-LSA中代表始发该LSA的设备的Router ID，这里即是R2自己的Router ID。
- Advertising Router：通告路由器

类型|名称|发布者|传播范围|信息描述
:---:|:---:|:---:|:---:|:---:
Type 1 |Router-LSA|所有|本区域内泛洪|描述某区域内路由设备端口链路状态的集合
Type 2 |Network-LSA|DR|DR 所属区域内泛洪|描述该网络上所连接路由设备 Router ID 列表
Type 3 |Network-Summary-LSA|ABR|通告给其他相关区域|区域内所有网段的路由信息
Type 4 |ASBR-Summary-LSA|ABR|通告给除 ASBR 所在的其他区域|描述到 ASBR 的路由信息
Type 5 |AS-external-LSA|ASBR|整个 AS（除了 STUB 和 NSSA 区域）|描述到 AS 外部的路由
Type 7 |NSSA-LSA|NSSA 区域的 ASBR|NSSA 区域|描述到 AS 外部的路由，当到达 NSSA ABR 时转化为 Type-5 LSA。

### 1

Router-LSA的信息字段有三个，用于将自己连接的所有链路的状况以及开销告诉该LSA泛洪区域的其他路由设备。

- Link ID:192.168.23.2
- Link Type: Transit
- Data: 192.138.23.1
- Metric: 1

该LSA描述的信息就是链路类型为一个传送网络（Transit），DR接口的IP地址为192.168.23.2（ID），和网络相连的通告路由器接口的IP地址是192.138.23.1（Data），到达该网络的花费值是1（Metric）。

（路由设备就是根据这些链路状态的描述从而生成拓扑）。

### 3

Network-summary-LSA由区域边界路由器ABR发布，用来描述区域间的路由信息，ABR将Network-summary-LSA发布到一个区域，通告该区域到其他区域的目的地址。实际上就是将区域内部的Type1 Type2的信息收集起来以路由子网的形式扩散出去，这就是Summay的含义，如图9所示，R2作为ABR，将Area0和Area1中的路由信息分别发布对方区域。

ABR相当于通信联络员，负责村子与村子之间的通信。ABR将一个村子的Type1 Type2的信息进行汇总形成路由信息传递到另外一个村子，另外一个村子同样将该村Type1 Type2的信息进行汇总形成路由信息传递到这个村子。

ABR收到来自同区域其它ABR传来的Type 3 LSA后，会重新生成新的Type3 LSA（Advertising Router改为自己），然后继续在整个OSPF系统内扩散。

### 4

R2 LSDB中还有一种叫ASBR-summary-LSA，也叫Type4 LSA，中文名为ASBR汇总LSA。

如图12所示，该类型LSA也是由ABR发布，描述到ASBR的路由信息，并通告给除ASBR所在区域的其他相关区域。

ASBR也是通信联络员，与ABR不同的是，ASBR是部落间的通信员，负责部落间的通信。一个部落所有村子里的村民如果想要和其他部落通信，必须经过ASBR。ASBR-summary-LSA的作用就是告诉非ASBR所在村的其他村的村民，ASBR在哪，怎么才能去ASBR。

### 5

在R2的LSDB中，还有最后一种LSA―External，即AS-external-LSA，也叫Type5 LSA，中文名为AS外部LSA。顾名思义，此种LSA是描述到AS外部的路由，由自治系统边界路由器ASBR发布，在整个AS中泛洪（除了STUB区域和NSSA区域，后面章节会详细介绍到）。如图15，R4作为ASBR发布了一条OSPF AS到外部目的网络的路由信息。

这种很容易理解了，就是部落内任意一个村民到该部落外部的路由。由部落间通信联络员ASBR发布。

### 7

NSSA区域允许本区域ASBR引入的外部路由在该区域内传播，但不允许其他区域引入的外部路由在本区域内传播。
AS-external-LSA是在整个AS泛洪，而NSSA LSA仅仅是在NSSA区域中泛洪。

NSSA区域允许引入外部路由，但外部路由信息的NSSA LSA只能在本区域泛洪，那外部路由如何能传递给整个自治域呢？Type7 LSA在ABR（R3）上转换成Type5 LSA，并且泛洪到骨干区直至整个自治域中。这样就将外部路由引入到了除NSSA区域的其他区域。

注意一条默认路由

## OSPF 特殊区域

### stub 区域

stub 含义是被截断的物品或实体，对于网络而言，stub 含义即被截断的网络。

Stub区域和Totally Stub区域

我们来看一下图1所示的网络，OSPF划分了Area 0和Area 2，同时在Area 0内有的ASBR引入了外部路由。通常，为了保证网络的路由可达性，可能把网络的各个角落的路由全都发布进了OSPF，此时虽然各路由设备都能够到达网络的各个角落了，但是如果网络越来越大，设备越来越多，那么每台设备的路由表项就会越来越大，而维护一个大规模的路由表项是需要消耗很多CPU及内存资源的。特别是对于一些边缘区域，设备性能可能比较低，如果也需要维护这么大规模的路由表项的话可能是一种巨大的压力。

从网络优化的角度考虑，我们通常在保证网络可达性的同时尽量减小路由表项的规模，尽量减少网络中LSA报文的泛洪。

对于Area 2中的路由器，无论他们想到达的域外的哪个网络，都必须首先到达到ABR路由器，也就是说这个时候Area 2中的路由器并不需要了解外部网络的细节，它仅需要通过ABR路由器到达外面的世界就可以了。这种情况下，就产生了OSPF的第一种类型的特殊区域――Stub区域。 配置Stub之后，自治系统外部的路由就不会在本区域内传播了，这样就减少了Area 2中LSA数量。

如果Area 2中的路由器想进一步减少自己的路由表项的规模呢？仔细分析一下可以看出，对于Area 2中的路由器来说，其实区域间的明细路由它也没必要都了解，仅保留一个出口让Area 2中的路由器的数据包能够出去就足够了。这就产生了OSPF的第二种类型的特殊区域――Totally Stub区域，也叫完全Stub区域。配置了Totally Stub区域以后，既不允许自治系统外部的路由在区域内传播，也不允许区域间路由在区域内传播。这样就能达到进一步减少区域内LSA数量的目的。

### NSSA区域和Totally NSSA区域

如图2所示，假设Area2原来作为一个Stub区域运行，但是某一天有个外部网络需要通过Area2接入到这个OSPF网络。也就是需要将自治域外部路由引入并传播到整个OSPF自治域中，此时可以在RTA上将外部路由注入到OSPF域，但是这种配置将使RTA成为ASBR，因此，Area2也就不是Stub区域了。 针对这种场景，OSPF定义了NSSA区域（Not-So-Stubby-Area NSSA） ，为了容易记忆，大家可以把它叫做“不那么Stub区域”，意思是在Stub区域的基础上做了一定的变通（允许引入外部路由了），所以就变得“不那么Stub”了。类似的，如果想进一步减少LSA数量，可以配置成Totally NSSA区域。

### 细节

Stub区域不允许自治系统外部的路由（Type5 LSA）在区域内传播，也不允许到达ASBR的Type4 LSA在区域内传播。因此这些区域中路由设备的路由表规模以及路由信息传递的数量都会大大减少。这样一来Stub区域内的路由器除了ABR外没有自治系统外部路由，如果它们想到自治系统外部时该怎么办呢？为保证到自治系统外的路由依旧可达，Stub区域的ABR将生成一条默认路由，并发布给Stub区域中的其他非ABR路由器。

一般情况下，Stub区域位于自治系统的边界，是只有一个ABR的非骨干区域。配置Stub区域的时候需要注意：

- 骨干区域不能配置成Stub区域。
- Stub区域内不能存在ASBR，因此自治系统外部的路由不能在本区域内传播。
- 虚连接不能穿过Stub区域。

配置Area1为Stub区域以后，R1上自治系统外部路由消失了，取而代之的是一条ABR（R2）自动下发的默认路由，是Type3 LSA描述的。
，此时Type5 LSA（External）、Type4 LSA（Sum-Asbr）已经消失，取而代之的是一条ABR（R2）自动下发的默认路由Type3 LSA。此时R1上仅有Type1、Type2、Type3以及Type3默认路由这几种LSA。

Stub区域能够起到减少区域内路由表项规模的作用，但是这似乎还不够彻底，实际上也可以不关心区域间的路由细节，而仅预留一个到达其他区域的出口即可。这种情况下可以将这个区域配置成Totally Stub区域。

Totally Stub区域既不允许自治系统外部的路由在区域内传播，也不允许区域间路由在区域内传播。区域内的路由设备必须通过ABR学到自治系统外部和其他区域的路由。实现方法是配置Totally Stub区域后，ABR会自动产生一条缺省的Summary LSA（Type3 LSA）通告到整个Totally Stub区域内。这样，自治系统外部的路由和其他区域间的路由都可以通过ABR到达。

现在将Area1配置为Totally Stub区域。将配置修改为如下：

此时R1的LSDB里面Type5 LSA（External）、Type4 LSA（Sum-Asbr）、以及描述区域间路由的Type3 LSA都已经消失，取而代之的是一条ABR（R2）自动发的默认路由Type3 LSA。

NSSA

NSSA区域允许引入少量通过本区域的ASBR到达的外部路由，但不允许其他区域的外部路由ASE LSA（Type5 LSA）在区域内传播。ABR自动产生一条缺省的NSSA LSA（Type7 LSA），通告到整个NSSA区域内。这样，除了某少部分路由通过NSSA的ASBR到达，其它路由都可以通过NSSA的ABR到达。在ASBR上手动通过命令进行配置，使ASBR产生一条缺省的NSSA LSA（Type7 LSA），通告到整个NSSA区域内。这样，外部路由也可以通过本区域NSSA的ASBR到达。Type7 LSA默认路由不会在ABR上转换成Type5 LSA默认路由泛洪到整个OSPF域。

现在将Area2区配置成NSSA区域。将配置修改为如下：

### 总结

区域|中文|特征|区域内普通 Router|区域内 ABR|区域内 ASBR|使用场景
:---:|:---:|:---:|:---:|:---:|:---:|:---:
Stub Area|末端区域|**不允许自治系统外部的路由、到达 ASBR 的路由**在区域内传播|不需要告诉我外面世界的精彩细节（自治系统外路由），只需要给我个出口（默认路由）就行了。|ABR 生成默认路由发布给 stub 区域的非 ABR 设备|无|位于自治系统边界且需要一个 ABR 的非骨干区域，不需要了解自治系统外部路由。
Totally Stub Area|完全末端区域|在 stub 区域基础上，**还不允许区域间路由**在区域内传播|除了本区域内的事情，不要告诉我其他任何地方的精彩细节（自治系统外、区域间路由）|ABR 生成默认路由发布给 stub 区域的非 ABR 设备|无|在 stub 区域基础上还不需要了解区域间路由。
Not-So-Stubby Area|变通末端区域|**不允许其他区域到达 AS 外部的路由**在区域内传播，但**允许引入少量通过本区域的 ASBR 到达 AS 外部的路由。**|通过 ASBR 了解外面世界的精彩细节，通过 ABR 了解其他区域的精彩细节。|ABR 生成默认路由发布给 NSSA 区域的非 ABR 设备|ASBR 向区域内其他路由器发布 AS 外部的路由|在 stub 区域基础上需要在本区域引入外部路由，即本区域具有 ASBR。
Totally Not-So-Stubby Area|完全变通末端区域|在 NSSA 区域基础上，**还不允许区域间路由**在区域内传播|我了解外部 AS 的精彩细节，除此之外到其他区域去 ABR 就行|ABR 生成缺省的 Type3 和 Type7 默认路由发布到整个区域|ASBR 向区域内其他路由器发布 AS 外部的路由|在 totally stub 区域基础上还需要了解 AS 外路由。

区域|LSA
:---:|:---:
骨干区域|Type1、Type2、Type3、Type4、Type5
标准区域|Type1、Type2、Type3、Type4、Type5
Stub 区域|Type1、Type2、Type3、Type3 默认路由
Totally stub 区域|Type1、Type2、Type3 默认路由
NSSA 区域|Type1、Type2、Type3、Type7、Type7 默认路由
Totally NSSA 区域|Type1、Type2、Type3 默认路由、Type7、Type7 默认路由

## VPN

### OSPF 多实例

### OSPF 环路问题

CE 双归属

### OSPF 破环策略

- DN-bit：PE 在生成 Type3、 Type5 或 Type7 LSA 发布给 CE 时，将 DN 位 (Previously unsed bit) 置为 1，其他类型的 LSA 的 DN 位置为 0。当 PE 的 OSPF 多实例在进行计算时，忽略 DN 置位的 LSA，这样防止 PE 又从 CE 学到发出的 LSA 而引起环路。
- VPN Route Tag：PE 在生成 Type3、 Type5 或 Type7 LSA 发布给 CE 时，打上 Route Tag，当 PE 发现 LSA 的 Route Tag 和自身一样，则忽略该条 LSA。

由于 MCE 并不是 PE 设备，因此可以不检查 DN 位。

例如，华为路由器上，通过 `vpn-instance-capbility simple` 可禁止路由环路检测。

## OSPF 网络规划设计原则

### 网络稳定的基石 - Router ID 规划

自动选择原则：

- ...
- ...

首先规划一个私有网段用于 OSPF 的 Router ID 选择，在启动进程前，建立 Loopback 接口，使用一个 32 位掩码的私有地址作为其 IP 地址，并将该地址作为路由设备的 Router ID。如果没有特殊要求，该地址无需发布在 OSPF 网络中。

### 层次化网络设计 - 区域规划

OSPF 是一个需要层次化设计的网络协议，从层次化的角度来看区域被分为两种：

- 骨干区域：骨干区域的编号为 0。
- 非骨干区域：非骨干区域的编号从 1 到 4294967295。

处于骨干区域和非骨干区域边界的 OSPF 路由器被称为 ABR（区域边界路由器）。实际上 OSPF 区域的规划也就是把网络中的 OSPF 路由器做归类的过程。

- 对于小型的网络：可以考虑仅规划一个骨干区域 Area 0。
- 对于大型的网络：一般在规划上都会遵循核心、汇聚、接入的分层原则。应该尽量减少接入路由的条目数量，把区域规划得更小一些或者使用特殊区域。

### 非骨干区域路由优化

在绝大部分的情况下，典型 OSPF 网络的非骨干区域中都仅仅需要知道缺省路由出口在哪里，因此建议把非骨干区域统一规划成 Totally NSSA 区域，这样将极大的精简非骨干区域内部路由器的路由条目数量，并且减少区域内部 OSPF 交互的信息量。对于少数存在特殊需求的网络，请根据实际情况灵活使用几种区域类型。

### 骨干区域路由优化

由于 OSPF 骨干区域需要负责区域之间的路由交互，所以骨干区域设备的路由表规模往往会比较大，因此骨干区域的路由表规模同样需要考虑精简和优化的问题。

骨干区域的路由优化同样是从非骨干区域入手，对非骨干区域使用的 IP 网段作出合理规划以便于区域边界的路由汇聚。

建议新建 OSPF 网络能够在前期就作出利于路由汇总的 IP 网络设计，对于扩建的网络尽量进行 IP 地址的重新规划，通过区域汇总能精简骨干区域路由器的路由表，减少骨干区域内 OSPF 交互的信息量。同时，路由汇总以后，单点的链路故障或者网络震荡不至于影响整个网络的路由更新，因此路由汇聚还可以提高网络的稳定性。

在很多场景下路由聚合确实能够做到精简路由，提高网络稳定性的作用，但是任何事物都具有两面性，路由聚合也不例外，路由聚合带来的缺陷就是容易产生路由环路，而**黑洞路由**可以用来弥补这种缺陷。所以典型 OSPF 网络设计中，路由聚合和黑洞路由往往是配合使用的。

### 选路优化

对于一个大型 OSPF 网络来说，很大一部分的业务流量并不在网络内部，而是通往 Internet 出口，因此缺省路由的设计也是典型 OSPF 网络的一大设计要点。

在实际的大多数工程案例中，典型网络的出口往往不止一个，如何有效的将出口流量分担到多条链路上就成为了 OSPF 设计中的一个难点。最简单也是最安全的方法是使用 OSPF 内在的选路机制。因为 OSPF 路由器对一条路由的优劣衡量是通过计算其 cost 值来实现的，cost 值小的路由会被路由器优先放入路由表。通过调整 OSPF 接口的 cost 值可以使得路由器选择不同的链路出口来达到负载分担的目的。

路由的 cost 值只与**出方向**的路径有关，路由器不会对入向流量执行路由决策。

在做 OSPF 选路调整时注意：如果需要调整 cost 值来影响 OSPF 的选路，则在链路两侧的设备上需要作出同样的 cost 调整，否则会形成不对称路由，引起网络故障。

### 静默接口

对于一个大型 OSPF 网络来说，安全性是必须要考虑到的问题。在 OSPF 网络设计中，通常会禁止将 OSPF 报文发往用户端，这主要是为了防止终端用户窥探OSPF 报文信息，因为如果用户能截获 OSPF 报文，那就意味着他可能知道如何加入此 OSPF 网络。此时要破坏这个 OSPF 网络已经是轻而易举的事。

### 案例实战

TODO

## 参考

- <http://forum.huawei.com/enterprise/zh/thread-219595.html>
