# IP 路由

## 路由基本原理

**路由器（Router）**是一种典型的网络连接设备，用来进行路由选择和报文转发。路由器根据收到**报文的目的地址**选择一条合适的路径（包含一个或多个路由器的网络），然后将报文传送到下一个路由器，路径终端的路由器负责将报文送交目的主机。

**路由**就是报文从源端到目的端的路径。当报文从路由器到目的网段有多条路由可达时，路由器可以根据**路由表**中最佳路由进行转发。**最佳路由**的选取与发现此路由的路由协议的优先级、路由的度量有关。

- 当多条路由的协议优先级与路由度量都相同时，可以实现负载分担，缓解网络压力；
- 当多条路由的协议优先级与路由度量不同时，可以构成路由备份，提高网络的可靠性。

路由器转发数据包的关键是**路由表**（Routing Table）和**转发表**（Forwarding Information Base），路由器通过路由表选择路由，通过 FIB 表指导报文进行转发。

无论何种平台的设备，路由表总是包括以下部分：

- 目的网段：表示此路由的目的地址。
- 掩码：表示目的地址子网掩码长度。
- 协议：表示学习此路由的路由协议。
- 路由协议优先级：。针对同一目的地，可能存在不同下一跳、出接口等多条路由，优先级高者将成为当前的最优路由。
- 路由开销：当到达同一目的地的多条路由具有相同的路由优先级时，路由开销最小的将成为当前的最优路由。
- 下一跳地址：指明数据转发的下一个设备端口地址。
- 出接口：指明数据将从本地路由器哪个接口转发出去。

【图】

在路由表选择出路由后，路由表会将激活路由下发到 FIB 表中。当报文到达路由器时，会通过查找 FIB 表进行转发。FIB 表的匹配遵循**最长匹配原则**。查找 FIB 表时，报文的目的地址和 FIB 中各表项的掩码进行按位“逻辑与”，得到的地址符合 FIB 表项中的网络地址则匹配，最终选择一个最长匹配的 FIB 表项转发报文。

## 路由分类

根据路由目的地的不同，路由可划分为：

- 网段路由：目的地为网段，IPv4 地址子网掩码长度小于 32 位或 IPv6 地址前缀长度小于 128 位。
- 主机路由：目的地为主机，IPv4 地址子网掩码长度为 32 位或 IPv6 地址前缀长度为 128 位。

根据目的地与该路由器是否直接相连，路由又可划分为：

- 直连路由：目的地所在网络与路由器直接相连。
- 间接路由：目的地所在网络与路由器非直接相连。

根据目的地址类型的不同，路由还可以分为：

- 单播路由：表示将报文转发的目的地址是一个单播地址。
- 组播路由：表示将报文转发的目的地址是一个组播地址。

本文内容聚焦于**单播路由**。

## 自治系统

在互联网中，**自治系统 AS**（Autonomous System）是指在一个（有时是多个）实体管辖下的所有 IP 网络和路由器的网络，它们对互联网执行共同的路由策略。一个 AS 内的所有网络都被分配同一个 AS 号，属于一个行政单位管辖。

## 路由协议

**路由协议**是路由器之间维护路由表的规则，用于发现路由，生成路由表，并指导报文转发。依据来源的不同，路由可以分为三类：

- 直连路由：通过链路层协议发现的路由。
- 静态路由：通过网络管理员手动配置的路由。
- 动态路由：通过动态路由协议发现的路由。

静态路由配置方便，对系统要求低，适用于拓扑结构简单并且稳定的小型网络。缺点是不能自动适应网络拓扑的变化，需要人工干预。动态路由协议有自己的**路由算法**，能够自动适应网络拓扑的变化。缺点是对系统的要求高于静态路由，并将占用一定的网络资源和系统资源。

对动态路由协议的分类可以采用以下不同标准：

根据作用范围不同，路由协议可分为：

- 内部网关协议 IGP（Interior Gateway Protocol）：在一个自治系统内部运行。
- 外部网关协议 EGP（Exterior Gateway Protocol）：运行于不同自治系统之间。

根据使用算法不同，路由协议可分为**距离矢量协议**（Distance-Vector Protocol）和**链路状态协议**（Link-State Protocol），两种算法的主要区别在于发现路由和计算路由的方法不同。

常用路由协议分类如下表所示：

|              | 内部网关协议 | 外部网关协议 |
| ------------ | ------------ | ------------ |
| 距离矢量协议 | RIP、EIGRP   | BGP          |
| 链路状态协议 | OSPF、IS-IS  |              |

## 路由可靠性

### 负载分担

当到达同一目的地存在同一路由协议发现的多条路由时，且这几条路由的开销值也相同，那么就满足负载分担的条件。

### 路由备份

### 快速重路由

## 路由策略

路由策略是通过一系列工具或方法对路由进行各种控制的“策略”。这种策略能够影响到路由产生、发布、选择等，进而影响报文的转发路径。这些工具包括ACL、route-policy、ip-prefix、filter-policy等，这些方法包括对路由进行过滤，设置路由的属性等。

路由策略的操作对象是路由信息。路由策略主要实现了路由过滤和路由属性设置等功能，它通过改变路由属性（包括可达性）来改变网络流量所经过的路径。

## 策略路由

策略路由的操作对象是数据包，在路由表已经产生的情况下，不按照路由表进行转发，而是根据需要，依照某种策略改变数据包转发路径。

所以这样可以看出，策略路由是在路由表之前起作用，如果报文匹配了策略路由，那么这个报文就不会再去查路由表了，而是直接按照策略路由的“指引”进行转发。所以策略路由是一个不太按照套路出牌的“家伙”，也正因为这样，策略路由的应用会更加灵活一点。

## 参考

- <https://forum.huawei.com/enterprise/zh/thread/580886844931981313>
