# IP 路由 - BGP 协议

## BGP 简介

## BGP 的产生

## BGP 核心思想

下图是一个典型的 BGP 组网图，其中包含三个 AS，AS 之间运行 BGP 协议，AS 65008 内部运行 OSPF 协议，其中 R3 上没有 OSPF 协议。BGP 根据连接建立的角色，又分为两种：

- EBGP：运行于 AS 之间两台设备建立的 BGP 关系。
- IBGP：运行于 同一 AS 之内两台设备建立的 BGP 关系。

![img](routing-bgp.assets/580889022547496960.png)

既然有了 OSPF，为何要有 IBGP 呢？假设没有 IBGP，R2 学到的 AS 65007 的路由和 R4 学到的 AS 65009 的路由是无法交互的。要想实现交互，则 R2 和 R4 必须将庞大的 BGP 路由和 OSPF 路由互相引入，这样 R1 上的路由才能扩散到 R5 上，然而，将数十万级别的 BGP 路由引入 IGP 中是无法容忍的。从上文可知，BGP 的邻居建立无需物理上相邻，只需路由可达即可，因此通过引入 IBGP，就可以实现 R2 和 R4 之间的路由同步。

## BGP 路由黑洞

上文介绍了 BGP 的核心思想，但上图中的网络存在一个严重问题。虽然全网控制面路由已经收敛了，但是转发面上数据包是却无法传输！这种现象称为**路由黑洞**。这是因为 R3 上并不知道任何关于 BGP 路由的信息，当 R1 给 R5 发送数据包时，R3 路由表内查询不到 R5 的网段，因此会丢弃数据。为了避免这种情况，BGP 采用了**同步机制**：BGP 向 EBGP 邻居通告自 IBGP 邻居的学到的路由时，必须保证该路由也存在于 IGP 中。简而言之，同步机制保证了 AS 域中路由的一致性。可是这不是又回到 BGP 与 IGP 互相引入的问题了吗？显然这个代价是无法接受的，但这仍然是一种可行的方案，因此一般 BGP 同步机制是默认关闭的。 BGP 需要其他的方式来解决路由黑洞问题。

- 物理全连接：任何两个路由器之间均为直连，那么 R2 就可以直接将数据转发至 R4，该方案弊端在于随着节点的增加，需要新增的链路数量几何增长。
- 逻辑全连接：任何两个路由器之间均建立 IBGP 连接，该方案弊端在于随着节点的增加，IBGP  的连接数也会几何增长。

![img](routing-bgp.assets/580889519702544384.png)

根据逻辑全连接的思路，BGP 提出了两种方案解决 IBGP 连接数量过多的问题。

### 联盟

联盟（Confederation）机制采用降低 AS 规模的思路来解决该问题。将 AS 域再次划分为多个 AS 域，被分割的 AS 称为**联盟**，分割后的多个 AS 称为**成员自治系统**，但联盟之外的 AS 将整个联盟视为一个 AS。成员自治系统之内运行 IBGP 全连接，成员自治系统之间运行一种特殊的 EBGP，称为**联盟 EBGP**。

![img](routing-bgp.assets/580889519916453888-16915890418754.png)

AS 号分为两种：

- 公有 AS：范围为 1-64511
- 私有 AS：范围为 65512-65535，共计 1024 个。

成员自治系统可以采用私有 AS 号。

### 路由反射器

路由反射器（Route Reflector）机制采用了构建一个逻辑上的星型网络来解决该问题。星型拓扑结构是用一个节点作为中心节点，其他节点直接与中心节点相连构成的网络。因此，反射机制中指定一个路由器成为 RR，作为整个 IBGP 连接网络的核心，其他设备和 RR 建立 IBGP 连接即可。

![img](routing-bgp.assets/580889521321545728.png)

此时，网络中的设备角色包括：

- 路由反射器 RR：允许把从 IBGP 对等体学到的路由反射到其他 IBGP 对等体的 BGP 设备。
- 客户机 Client：与 RR 形成反射邻居关系的 IBGP 设备。
- 非客户机 Non-Client：既不是 RR 也不是客户机的 IBGP 设备。在 AS 内部所有非客户机与所有 RR 之间仍然必须建立全连接关系。

- 始发者 Originator：在 AS 内部始发路由的设备。
- 集群 Cluster：RR 及其客户机的集合。

RR 向 IBGP 邻居发布路由规则如下：

- 从非客户机学到的路由，发布给所有客户机。

- 从客户机学到的路由，发布给所有非客户机和客户机（发起此路由的客户机除外）。
- 从 EBGP 对等体学到的路由，发布给所有的非客户机和客户机。

联盟和路由反射器都是在大规模自治系统中减少 IBGP 对等体数量的有效方法，有时两者共同使用将会更加方便。

![img](routing-bgp.assets/580889522344955904.png)

## 路由环路

BGP 是一种距离矢量路由协议，因此必须考虑防止环路机制。BGP 中分两种情况设计了防环机制。

### EBGP

EBGP 发生路由环路的**根本原因是路由的起源和经过的 AS 是不明确的**。因此，在路由传递时，附加上其经过的 AS 列表，路由器收到路由后检查 AS 列表，若包含自身 AS 号，则表示该路由已经在本 AS 内传播过，则不接收该路由。

### IBGP

IBGP路由环路产生的原因和 EBGP 类似，但是由于 IBGP 是在 AS 内部建立的 BGP 关系，所以无法通过记录路由经过的 AS 号来进行防环。对于 IBGP，协议采用了类似 RIP 的水平分割的机制，称之为 IBGP 水平分割，其内容为：从 IBGP 对等体接收到的路由不会通告给其他的IBGP邻居。

## BGP 属性

## 路由聚合

## 路由选路

## 参考

参考：<https://forum.huawei.com/enterprise/zh/thread-243715.html>
