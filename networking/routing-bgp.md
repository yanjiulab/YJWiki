# IP 路由 - BGP 协议

## BGP 简介

为方便管理规模不断扩大的网络，网络被分成了不同的**自治系统**（Autonomous System, AS），路由只在自治系统内部传播，因此缩小了网络规模。用于 AS 域内路由选择的协议称为**内部网关协议** (Interior Gateway Protocol, IGP)，常见的协议包括：

- RIP：距离矢量协议，多用于小型网络。
- IS-IS：链路状态协议，多用于运营商网络。
- OSPF：链路状态协议，多用于企业中大型网络。
- EIGRP：CISCO 私有路由协议，增强型距离矢量协议。

与此对应，**外部网关协议** (Exterior Gateway Protocol, EGP) 被用于实现在 AS 之间动态交换路由信息。包括：

- EGP：最初 EGP 的一种实现，但是 EGP 设计得比较简单，只发布网络可达的路由信息，而不对路由信息进行优选，同时也没有考虑环路避免等问题，很快就无法满足网络管理的要求。
- BGP：边界网关协议 (Border Gateway Protocol, BGP) 是一种实现自治系统之间路由可达、避免路由环路，并选择最佳路由的**距离矢量**路由协议。目前 BGP 已经成为事实上唯一的外部网关协议。

BGP 发展至今，早期发布的三个版本已经很少使用。

- BGP-1 (RFC 1105)
- BGP-2 (RFC 1163)
- BGP-3 (RFC 1267)

1994 年开始使用 BGP-4 (RFC 1771)，2006 年之后 BGP 的使用版本固定下来，分别是：

- 单播 IPv4 网络使用的版本是 BGP-4 (RFC 4271)。
- 其他网络使用的版本是多协议拓展 BGP，即 MultiProtocol-BGP，简称 MP-BGP (RFC 4760)，该协议对 BGP-4 进行了扩展，来达到在不同网络中应用的目的，BGP-4 原有的消息机制和路由机制并没有改变。
  - MP-BGP 在 IPv6 单播网络上的应用称为 BGP4+
  - MP-BGP 在 IPv4 组播网络上的应用称为 MBGP (Multicast BGP)
  - 其他统称 MP-BGP。

## BGP 的产生

AS 是指在一个实体管辖下的拥有相同选路策略的 IP 网络，每个 AS 都被分配一个唯一的 AS 号，用于区分不同的 AS。

【图】

能不能使用现有的 IGP 协议来进行 AS 之间的路由交换呢？首先链路状态协议（OSPF、ISIS）不适合用于交换 AS 之间的路由，因为链路状态协议需要拥有全局拓扑，这样会导致每一台路由器上都生成庞大的数据库。那么采用 RIP 这种距离矢量协议可以吗？很明显 RIP 有两个致命的问题：

1. RIP 协议 30 秒进行一次全量更新，AS 之间路由数量较多，很可能 30 秒都发送不完，这样带宽都被路由协议报文占满了，严重影响业务通信。
2. RIP 基于 UDP 协议实现，大量的 UDP 报文很可能丢失，造成路由不同步。

因此，需要重新设计一种新的距离矢量协议用于 AS 之间路由交换，这就是 BGP 产生的原因。因此，BGP 的两个核心思想就是：

1. AS 之间路由较多，不适合全量更新，应当为**增量更新**。
2. **基于 TCP 可靠通信**进行路由交换。

## BGP 核心思想

BGP 基于 TCP（179 端口）设计，那么就不能使用 RIP 那种通过组播 Hello 的方式进行邻居发现和维护了，需要设计新的机制。 TCP 建立连接必须知道对端 IP 地址，且路由可达。因此就有静态配置或动态配置两种方式，BGP 采用了静态配置的方式，只要双方路由可达，就可以建立连接。静态配置具有两个好处：

1. 可以与对端设备用任何 IP 建立邻居关系，而不是局限于某个固定接口的 IP，这样就可以采用回环口建立邻居，使得路由更加稳定。
2. 可以跨越多个设备建立邻居，用于 AS 内部建立 BGP 连接（后文详述）。

建立邻居之后，就可以在这个 TCP 连接之上传输路由了，具体流程如下：

- BGP 使用 **OPEN 报文**建立邻居，若建立失败，则过一段时间后再次尝试建立。
- BGP 邻居建立后，使用 **UPDATE 报文**进行路由表同步。
- 路由同步完成后，通过定期发送 **KEEPALIVE 报文**维持 TCP 连接，这样可以不用重新建立连接，立刻进行路由更新。
- BGP 通过发送 **NOTIFICATION 报文**中断 BGP 连接。
- 如果 3 个保活周期没有收到对端的保活报文，则拆除 TCP 连接，并且删除从对方收到的所有路由。

## BGP 路由黑洞

EBGP：运行于AS之间两台设备的BGP关系。
IBGP：运行于AS内部两台设备的BGP关系。

路由传递成功，数据包不行。路由黑洞，解决方案：1，引入路由，代价高同步开销太大。2，物理全练接。3，逻辑全连接。

本质问题是：在控制面中，有一个设备不知道路由信息。解决方案是必须所有设备都能学习到路由信息。

解决上一部分问题，1，联盟，2反射

- 联盟思路：通过划分成员自治系统降低自治系统规模，成员 AS 之间建立联盟 EBGP
- 反射思路：指定一个路由器成为 RR，作为整个 IBGP 全连接网络的核心。

反射的话，集群环路问题需要使用 originator 实现，当发布给 client 时，检查 originator 值，若相同则丢弃。

### 物理全连接

### 逻辑全连接

### 联盟

### 反射

## 路由环路

### EBGP

其实就是 192.168.16.0/24 这条路由的起源和经过的AS是不明确的。
添加一个经过列表即可。

### IBGP

IBGP路由环路产生的原因和EBGP类似，但是由于IBGP是在AS内部建立的BGP关系，所以无法通过记录路由经过的AS号来进行防环。对于IBGP，协议采用了类似RIP的水平分割的机制，我们称之为IBGP的水平分割，其内容为：从IBGP对等体接收到的路由不会通告给其他的IBGP邻居。

路由老祖将这前因后果说与交换机，交换机方才明白，怪不得之前自己这边发出的流量越多，压力越大，直至后来完全无法支撑，原来并非神功不灵，而是运功方式不得其法。

路由老祖道：“BGP神功千变万化，万不可拘泥于你之前修炼IGP所用方法。在修炼BGP神功时，你要牢记“属性”二字。这二字说来简单，其中所包含义绝非一时所能理解，你以后修炼中慢慢领悟，待你完全理解之时，就是你神功大成之日！”

交换机不解道：“何为“属性”？”

## BGP 属性

## 路由聚合

## 路由选路

## 参考

参考：<https://forum.huawei.com/enterprise/zh/thread-243715.html>
