# IP 路由 - BGP 协议

## BGP 简介

为方便管理规模不断扩大的网络，网络被分成了不同的自治系统（Autonomous System, AS）。内部网关协议 (Interior Gateway Protocol, IGP) 用于 AS 域内路由选择。

- RIP：距离矢量协议，多用于小型网络。
- ISIS：链路状态协议，多用于运营商网络。
- OSPF：链路状态协议，多用于企业中大型网络。
- EIGRP：CISCO 私有路由协议，增强型距离矢量协议。

与此对应，外部网关协议 (Exterior Gateway Protocol, IGP) 被用于实现在 AS 之间动态交换路由信息。但是 EGP 设计得比较简单，只发布网络可达的路由信息，而不对路由信息进行优选，同时也没有考虑环路避免等问题，很快就无法满足网络管理的要求。

边界网关协议 (Border Gateway Protocol, BGP) 是一种实现自治系统之间路由可达、避免路由环路，并选择最佳路由的**距离矢量**路由协议。早期发布的三个版本分别是

- BGP-1 (RFC 1105)
- BGP-2 (RFC 1163)
- BGP-3 (RFC 1267)

1994 年开始使用 BGP-4 (RFC 1771)，2006 年之后 BGP 的使用版本固定下来，分别是：

- 单播 IPv4 网络使用的版本是 BGP-4 (RFC 4271)。
- 其他网络使用的版本是多协议拓展 BGP，即 MultiProtocol-BGP，简称 MP-BGP (RFC 4760)，该协议对 BGP-4 进行了扩展，来达到在不同网络中应用的目的，BGP-4 原有的消息机制和路由机制并没有改变。
  - MP-BGP 在 IPv6 单播网络上的应用称为 BGP4+
  - MP-BGP 在 IPv4 组播网络上的应用称为 MBGP (Multicast BGP)

## BGP 核心思想

- UDP 不可靠；
- 30 秒一次全量更新，数据太大；改为增量更新。

要修改：

- TCP建立连接，需要知道IP地址，那么静态配置或者动态。跨设备建立，没有接口限制。
- 使用open报文建立邻居
- 使用update报文更新邻居
- 发送 keepalive 维持连接
- 3个周期没有，拆连接删除路由

## 路由黑洞

EBGP：运行于AS之间两台设备的BGP关系。
IBGP：运行于AS内部两台设备的BGP关系。

路由传递成功，数据包不行。路由黑洞，解决方案：1，引入路由，代价高同步开销太大。2，物理全练接。3，逻辑全连接。

本质问题是：在控制面中，有一个设备不知道路由信息。解决方案是必须所有设备都能学习到路由信息。

解决上一部分问题，1，联盟，2反射

- 联盟思路：通过划分成员自治系统降低自治系统规模，成员 AS 之间建立联盟 EBGP
- 反射思路：指定一个路由器成为 RR，作为整个 IBGP 全连接网络的核心。

反射的话，集群环路问题需要使用 originator 实现，当发布给 client 时，检查 originator 值，若相同则丢弃。

### 物理全连接

### 逻辑全连接

### 联盟

### 反射

## 路由环路

### EBGP

其实就是 192.168.16.0/24 这条路由的起源和经过的AS是不明确的。
添加一个经过列表即可。

### IBGP

IBGP路由环路产生的原因和EBGP类似，但是由于IBGP是在AS内部建立的BGP关系，所以无法通过记录路由经过的AS号来进行防环。对于IBGP，协议采用了类似RIP的水平分割的机制，我们称之为IBGP的水平分割，其内容为：从IBGP对等体接收到的路由不会通告给其他的IBGP邻居。

路由老祖将这前因后果说与交换机，交换机方才明白，怪不得之前自己这边发出的流量越多，压力越大，直至后来完全无法支撑，原来并非神功不灵，而是运功方式不得其法。

路由老祖道：“BGP神功千变万化，万不可拘泥于你之前修炼IGP所用方法。在修炼BGP神功时，你要牢记“属性”二字。这二字说来简单，其中所包含义绝非一时所能理解，你以后修炼中慢慢领悟，待你完全理解之时，就是你神功大成之日！”

交换机不解道：“何为“属性”？”

## BGP 属性

## 路由聚合

## 路由选路

## BGP 基本概念

BGP 使用 TCP 作为其传输层协议（端口号为179），

## 参考

参考：<https://forum.huawei.com/enterprise/zh/thread-243715.html>
